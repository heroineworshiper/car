#include <stdio.h>
#include <math.h>


// heading error
float data[] = 
{

	-0.265108, -0.273658, -0.281608, -0.286474, -0.292949, -0.298608,
	-0.303787, -0.308411, -0.3111, -0.315139, -0.318422, -0.321265,
	-0.322939, -0.322569, -0.321168, -0.317377, -0.311599, -0.304282,
	-0.295941, -0.286913, -0.280373, -0.270172, -0.259423, -0.247961,
	-0.235735, -0.227134, -0.213768, -0.200436, -0.187376, -0.174352,
	-0.165566, -0.152398, -0.139629, -0.128042, -0.117949, -0.108561,
	-0.103014, -0.095592, -0.089084, -0.08338, -0.078103, -0.074922,
	-0.07055, -0.06798, -0.066893, -0.067359, -0.069354, -0.071709,
	-0.07606, -0.081539, -0.087875, -0.094036, -0.098008, -0.104376,
	-0.111256, -0.11858, -0.12553, -0.132314, -0.137149, -0.144628,
	-0.152888, -0.16155, -0.170409, -0.176251, -0.18464, -0.192393,
	-0.199061, -0.204097, -0.207669, -0.209016, -0.209398, -0.207727,
	-0.204623, -0.199772, -0.195541, -0.187843, -0.178469, -0.167607,
	-0.155825, -0.143446, -0.135013, -0.121975, -0.108297, -0.094014,
	-0.079947, -0.066781, -0.058609, -0.047771, -0.037967, -0.028773,
	-0.019939, -0.014178, -0.005353, 0.002885, 0.010409, 0.017574,
	0.022097, 0.02814, 0.033311, 0.037589, 0.041198, 0.043752, 0.04472,
	0.044868, 0.043721, 0.041006, 0.036562, 0.030463, 0.025817,
	0.018381, 0.010525, 0.001579, -0.007983, -0.014665, -0.025271,
	-0.036078, -0.047017, -0.057544, -0.06692, -0.072445, -0.07999,
	-0.086898, -0.093657, -0.099667, -0.103415, -0.108775, -0.114002,
	-0.118832, -0.1235, -0.126467, -0.129874, -0.131575, -0.131404,
	-0.128722, -0.123907, -0.119808, -0.113132, -0.105675, -0.097773,
	-0.089112, -0.079662, -0.072969, -0.062209, -0.050736, -0.038874,
	-0.027272, -0.019751, -0.008684, 0.002904, 0.014856, 0.027042,
	0.038029, 0.044596, 0.053736, 0.061723, 0.068475, 0.074045,
	0.077251, 0.081553, 0.084563, 0.085997, 0.085235, 0.083445,
	0.079254, 0.073621, 0.066658, 0.058356, 0.049894, 0.044329, 0.03551,
	0.025814, 0.016226, 0.006724, -0.002597, -0.008435, -0.01706,
	-0.025843, -0.035171, -0.045032, -0.051662, -0.061713, -0.071436,
	-0.08026, -0.088671, -0.095901, -0.099982, -0.104884, -0.108424,
	-0.111182, -0.112133, -0.111511, -0.109583, -0.105653, -0.100006,
	-0.092893, -0.084656, -0.078386, -0.06838, -0.058122, -0.047435,
	-0.036373, -0.029058, -0.018095, -0.007133, 0.003544, 0.013549,
	0.022232, 0.027628, 0.035277, 0.042624, 0.049592, 0.055835,
	0.059548, 0.064939, 0.069312, 0.072466, 0.07428, 0.074787, 0.074346,
	0.072751, 0.069582, 0.064968, 0.059314, 0.055235, 0.049041,
	0.042403, 0.034244, 0.025804, 0.016411, 0.009647, -0.00107,
	-0.012355, -0.023469, -0.03371, -0.040219, -0.049181, -0.056975,
	-0.064155, -0.070724, -0.074469, -0.079088, -0.08309, -0.086539,
	-0.089445, -0.091902, -0.093006, -0.094167, -0.09358, -0.091188,
	-0.087178, -0.083634, -0.076909, -0.069085, -0.060706, -0.051965,
	-0.043106, -0.037186, -0.027999, -0.018801, -0.009488, -0.000256,
	0.00607, 0.015287, 0.02422, 0.032481, 0.040743, 0.049038, 0.054165,
	0.06122, 0.067297, 0.071973, 0.074887, 0.075971, 0.076381, 0.07544,
	0.073105, 0.069487, 0.063635, 0.058505, 0.049475, 0.039523,
	0.028515, 0.017033, 0.005424, -0.002531, -0.014371, -0.025657,
	-0.036381, -0.046685, -0.05299, -0.061377, -0.069031, -0.075883,
	-0.082527, -0.086926, -0.09325, -0.099116, -0.104611, -0.109598,
	-0.113795, -0.116119, -0.118455, -0.119553, -0.119036, -0.115968,
	-0.113052, -0.107794, -0.101468, -0.09458, -0.086917, -0.078571,
	-0.07251, -0.062317, -0.051378, -0.039931, -0.02865, -0.017676,
	-0.010374, 0.000768, 0.012237, 0.023624, 0.034564, 0.041333,
	0.050532, 0.058873, 0.066608, 0.073653, 0.077906, 0.083701,
	0.087692, 0.089561, 0.089376, 0.0869, 0.084601, 0.080034, 0.074357,
	0.067305, 0.059379, 0.053713, 0.044737, 0.035429, 0.02599, 0.016289,
	0.006764, 0.000542, -0.008577, -0.017911, -0.027718, -0.038403,
	-0.045579, -0.055972, -0.065631, -0.074687, -0.082721, -0.089334,
	-0.09313, -0.097466, -0.100576, -0.102501, -0.103512, -0.103308,
	-0.101456, -0.097737, -0.09261, -0.086071, -0.078314, -0.072565,
	-0.063375, -0.053622, -0.043599, -0.033403, -0.023371, -0.01693,
	-0.007365, 0.001635, 0.010052, 0.018282, 0.02346, 0.030641,
	0.037501, 0.044044, 0.050288, 0.05418, 0.059087, 0.063025, 0.065494,
	0.066769, 0.067164, 0.066886, 0.065269, 0.062163, 0.058006,
	0.052813, 0.048375, 0.040911, 0.032957, 0.023475, 0.012965,
	0.001649, -0.006171, -0.018292, -0.030211, -0.041762, -0.052449,
	-0.058855, -0.067889, -0.075549, -0.08229, -0.088853, -0.09494,
	-0.098654, -0.103897, -0.108476, -0.112723, -0.116183, -0.118023,
	-0.119884, -0.119615, -0.117809, -0.114096, -0.110505, -0.10388,
	-0.096455, -0.088388, -0.080129, -0.071401, -0.065048, -0.054643,
	-0.043854, -0.03284, -0.021525, -0.010796, -0.003928, 0.006569,
	0.017038, 0.027862, 0.038635, 0.045439, 0.054005, 0.061148,
	0.067244, 0.072226, 0.074942, 0.078432, 0.080383, 0.080717,
	0.079059, 0.075187, 0.07134, 0.064856, 0.057184, 0.049087, 0.040647,
	0.03495, 0.026031, 0.016895, 0.007653, -0.000924, -0.008614,
	-0.013329, -0.020149, -0.027168, -0.033944, -0.041309, -0.046556,
	-0.054879, -0.062675, -0.069793, -0.076299, -0.082486, -0.086224,
	-0.090635, -0.09397, -0.09532, -0.094151, -0.092351, -0.087994,
	-0.081724, -0.073613, -0.06465, -0.058275, -0.04828, -0.037669,
	-0.026864, -0.015635, -0.004115, 0.007782, 0.015758, 0.027606,
	0.038798, 0.04911, 0.058941, 0.065399, 0.074766, 0.083941, 0.092411,
	0.100713, 0.105917, 0.113045, 0.118254, 0.121882, 0.123845, 0.12353,
	0.122396, 0.11932, 0.114979, 0.109316, 0.10268, 0.097578, 0.089023,
	0.079571, 0.069411, 0.059362, 0.04908, 0.041778, 0.030863, 0.019575,
	0.008212, -0.002665, -0.009565, -0.01948, -0.028406, -0.03647,
	-0.043662, -0.050079, -0.053776, -0.058517, -0.062687, -0.066449,
	-0.069333, -0.070865, -0.072492, -0.072798, -0.071507, -0.068774,
	-0.066073, -0.060536, -0.053607, -0.046272, -0.038688, -0.030605,
	-0.024478, -0.015163, -0.006097, 0.003062, 0.012281, 0.02134,
	0.027366, 0.035838, 0.044305, 0.0525, 0.060007, 0.06442, 0.069892,
	0.073876, 0.077106, 0.079354, 0.08043, 0.081182, 0.080359, 0.07746,
	0.073167, 0.06704, 0.062101, 0.05425, 0.045509, 0.035586, 0.024734,
	0.017116, 0.005025, -0.006791, -0.017994, -0.028177, -0.037511,
	-0.042973, -0.050703, -0.05795, -0.064416, -0.07028, -0.073786,
	-0.078582, -0.082924, -0.087238, -0.090565, -0.093289, -0.094876,
	-0.096399, -0.096597, -0.095379, -0.093019, -0.090821, -0.086585,
	-0.081344, -0.075195, -0.068348, -0.060762, -0.055118, -0.046339,
	-0.037942, -0.030007, -0.022083, -0.016622, -0.008228, 0.000365,
	0.009052, 0.017466, 0.024642, 0.028663, 0.033822, 0.037581,
	0.039945, 0.041014, 0.040562, 0.038218, 0.033449, 0.026829,
	0.018656, 0.009591, 0.002932, -0.008428, -0.020491, -0.032582,
	-0.044082, -0.051361, -0.061054, -0.069822, -0.078224, -0.086054,
	-0.093506, -0.098396, -0.106027, -0.114018, -0.121928, -0.1296,
	-0.134468, -0.141216, -0.147565, -0.15289, -0.156848, -0.159278,
	-0.159842, -0.159164, -0.157406, -0.153902, -0.148492, -0.144023,
	-0.135979, -0.126804, -0.117045, -0.106858, -0.0963, -0.089269,
	-0.078222, -0.066913, -0.055618, -0.0449, -0.038339, -0.029274,
	-0.020382, -0.012025, -0.004307, 0.003153, 0.007747, 0.014389,
	0.020548, 0.02638, 0.030701, 0.033191, 0.035715, 0.03703, 0.037515,
	0.036768, 0.034409, 0.031541, 0.025932, 0.018532, 0.009705,
	0.000632, -0.00518, -0.015296, -0.025581, -0.036613, -0.048259,
	-0.055804, -0.066884, -0.077675, -0.088394, -0.098579, -0.108079,
	-0.113756, -0.121288, -0.127549, -0.132788, -0.137126, -0.140387,
	-0.142087, -0.14396, -0.144353, -0.143688, -0.142256, -0.140846,
	-0.137504, -0.133034, -0.127663, -0.121412, -0.116648, -0.108908,
	-0.101005, -0.092909, -0.084382, -0.075414, -0.069345, -0.060432,
	-0.051802, -0.043657, -0.035689, -0.030538, -0.022848, -0.015762,
	-0.009427, -0.004155, 0.000181, 0.002125, 0.003863, 0.004784,
	0.004852, 0.003789, 0.001612, -0.00033, -0.004384, -0.010255,
	-0.017637, -0.02588, -0.032103, -0.042109, -0.052802, -0.06422,
	-0.075945, -0.083708, -0.094956, -0.105471, -0.114989, -0.12322,
	-0.130337, -0.134685, -0.140437, -0.145501, -0.149854, -0.153128,
	-0.155519, -0.156664, -0.157474, -0.156952, -0.15508, -0.151417,
	-0.14827, -0.142788, -0.136542, -0.129989, -0.122691, -0.114216,
	-0.108157, -0.098588, -0.088461, -0.07786, -0.067124, -0.059687,
	-0.048484, -0.037101, -0.025679, -0.015244, -0.009389, -0.000752,
	0.007277, 0.014129, 0.019369, 0.02352, 0.025927, 0.029029, 0.031594,
	0.032637, 0.031644, 0.028441, 0.02489, 0.018246, 0.010748, 0.002881,
	-0.005726, -0.011896, -0.022066, -0.033004, -0.043988, -0.053712,
	-0.062238, -0.067725, -0.076046, -0.085062, -0.094121, -0.102718,
	-0.108401, -0.116434, -0.124113, -0.131627, -0.138549, -0.144615,
	-0.148126, -0.152171, -0.155139, -0.157005, -0.156896, -0.154832,
	-0.15208, -0.146122, -0.137856, -0.127907, -0.116582, -0.108591,
	-0.096616, -0.084583, -0.072656, -0.060397, -0.052006, -0.039216,
	-0.027039, -0.016021, -0.006007, 0.003285, 0.009133, 0.017301,
	0.025258, 0.033156, 0.040728, 0.045338, 0.051652, 0.056192,
	0.059191, 0.061139, 0.061903, 0.061591, 0.059881, 0.056593,
	0.051541, 0.044992, 0.037508, 0.032144, 0.023525, 0.015002,
	0.006387, -0.002682, -0.008796, -0.018528, -0.028592, -0.03884,
	-0.049188, -0.055994, -0.065859, -0.075374, -0.08427, -0.092339,
	-0.099097, -0.102994, -0.108084, -0.112252, -0.115226, -0.117313,
	-0.117605, -0.116811, -0.113999, -0.110058, -0.104809, -0.098343,
	-0.093712, -0.086139, -0.077993, -0.069632, -0.060922, -0.051846,
	-0.045508, -0.036196, -0.027396, -0.018872, -0.010458, -0.004736,
	0.004245, 0.013103, 0.02129, 0.02882, 0.032737, 0.037744, 0.041441,
	0.043866, 0.044911, 0.044695, 0.044042, 0.042533, 0.040691,
	0.037484, 0.032821, 0.026133, 0.021105, 0.013031, 0.004418,
	-0.004592, -0.014105, -0.020583, -0.031098, -0.041802, -0.05179,
	-0.060475, -0.06828, -0.072363, -0.076685, -0.080555, -0.083239,
	-0.085112, -0.085977, -0.086809, -0.087049, -0.086497, -0.085125,
	-0.083994, -0.08187, -0.079414, -0.076444, -0.072728, -0.068278,
	-0.06493, -0.05948, -0.053574, -0.048, -0.042163, -0.036226,
	-0.032185, -0.026142, -0.019938, -0.013588, -0.008362, -0.005114,
	-0.00105, 0.002354, 0.004729, 0.005203, 0.004142, 0.002693,
	-0.000793, -0.00526, -0.009996, -0.014758, -0.018284, -0.02425,
	-0.03106, -0.038737, -0.047298, -0.056378, -0.062613, -0.071844,
	-0.081124, -0.090061, -0.098675, -0.104253, -0.112008, -0.118418,
	-0.123899, -0.12864, -0.13258, -0.13449, -0.135779, -0.135274,
	-0.132729, -0.12874, -0.125253, -0.118964, -0.111638, -0.103323,
	-0.094443, -0.085407, -0.079049, -0.068919, -0.058139, -0.047064,
	-0.035848, -0.028413, -0.017549, -0.006386, 0.005176, 0.016383,
	0.027105, 0.033818, 0.042401, 0.049834, 0.055989, 0.060675,
	0.062574, 0.064443, 0.065213, 0.065189, 0.064484, 0.062959,
	0.061004, 0.056843, 0.050567, 0.042722, 0.03414, 0.027959, 0.018092,
	0.007906, -0.002919, -0.014271, -0.025632, -0.032934, -0.043363,
	-0.052998, -0.061546, -0.069373, -0.076866, -0.081762, -0.088579,
	-0.095062, -0.101076, -0.106414, -0.109613, -0.113611, -0.116742,
	-0.119142, -0.120929, -0.121573, -0.120433, -0.117329, -0.112202,
	-0.105667, -0.097565, -0.091485, -0.081097, -0.07008, -0.058632,
	-0.047181, -0.039418, -0.027907, -0.015769, -0.003633, 0.008488,
	0.019325, 0.025914, 0.035543, 0.044174, 0.05192, 0.059013, 0.06596,
	0.070308, 0.075852, 0.08026, 0.082589, 0.083385, 0.082639, 0.079547,
	0.074489, 0.067597, 0.059514, 0.050463, 0.043956, 0.033776,
	0.023246, 0.01255, 0.001892, -0.005191, -0.015437, -0.024952,
	-0.033865, -0.043186, -0.052897, -0.059321, -0.06903, -0.078611,
	-0.088069, -0.097093, -0.105276, -0.110174, -0.116346, -0.120991,
	-0.124068, -0.126213, -0.126976, -0.12583, -0.12318, -0.118348,
	-0.111987, -0.104411, -0.098723, -0.089562, -0.079786, -0.06959,
	-0.059614, -0.053161, -0.043351, -0.033101, -0.022786, -0.012876,
	-0.006416, 0.003118, 0.012692, 0.022284, 0.03172, 0.040832, 0.04687,
	0.055075, 0.061393, 0.066494, 0.069846, 0.071277, 0.071322,
	0.070351, 0.068122, 0.064424, 0.059279, 0.055111, 0.04782, 0.039378,
	0.030247, 0.020414, 0.009691, 0.002238, -0.009168, -0.02111,
	-0.032811, -0.043895, -0.050947, -0.061077, -0.071102, -0.08041,
	-0.08834, -0.093182, -0.099904, -0.106201, -0.111686, -0.116392,
	-0.120121, -0.122407, -0.123247, -0.123536, -0.122727, -0.121059,
	-0.118309, -0.115805, -0.111449, -0.106109, -0.099453, -0.091637,
	-0.082358, -0.075433, -0.064237, -0.052399, -0.040512, -0.029022,
	-0.021686, -0.010328, 0.00093, 0.011497, 0.021329, 0.03004,
	0.035301, 0.042058, 0.046912, 0.050304, 0.052454, 0.053495,
	0.054549, 0.054614, 0.052755, 0.04849, 0.042058, 0.036803, 0.028279,
	0.018928, 0.008669, -0.002315, -0.009851, -0.02171, -0.033456,
	-0.044394, -0.054385, -0.0637, -0.06973, -0.078559, -0.086931,
	-0.095025, -0.102705

};


// angular rate
float rate[] = 
{
};






#define TOTAL_ENTRIES (sizeof(data) / sizeof(float))
#define ORDER 2

typedef struct
{
	float bandwidth;
	float prev_output[ORDER];
	float prev_input[ORDER];
	float result;
} filter_t;


void init_filter(filter_t *ptr, float value, float bandwidth)
{
	int i;
	ptr->bandwidth = bandwidth;
	for(i = 0; i < ORDER; i++)
	{
		ptr->prev_output[i] = value;
		ptr->prev_input[i] = value;
	}
}

float do_highpass(filter_t *ptr, float value)
{
	int i;
	float result = value;
	for(i = 0; i < ORDER; i++)
	{
		result = ptr->bandwidth * (ptr->prev_output[i] + value - ptr->prev_input[i]);
		ptr->prev_input[i] = value;
		ptr->prev_output[i] = result;
		value = result;
	}
	
	return result;
}

float do_lowpass(filter_t *ptr, float value)
{
	int i;
	float result = value;
	for(i = 0; i < ORDER; i++)
	{
		result = ptr->prev_output[i] + ptr->bandwidth * (value - ptr->prev_output[i]);
		ptr->prev_output[i] = result;
		value = result;
	}
	
	return result;
}



void test_freq(float period, 
	float p_bandwidth, 
	float d_bandwidth,
	float *max_p_result,
	float *max_d_result)
{
	int n = 1024;
	int i;
	float data[n];
	float max_p = 0;
	float max_d = 0;
	
	for(i = 0; i < n; i++)
	{
		data[i] = sin(i * 2 * M_PI / period);
	}
	
	filter_t p_filter, d_filter;
	init_filter(&p_filter, data[0], p_bandwidth);
	init_filter(&d_filter, data[0], d_bandwidth);
	
	for(i = 1; i < n; i++)
	{

// lowpass filter
		float p = do_lowpass(&p_filter, data[i]);
		
// highpass filter
		float d = do_highpass(&d_filter, data[i]);
		
		
		
		if(p > max_p)
		{
			max_p = p;
		}
		
		if(d > max_d)
		{
			max_d = d;
		}
	}
	
	*max_p_result = max_p;
	*max_d_result = max_d;
}



void main()
{
	int i;
	float p_bandwidth = 1;
	float d_bandwidth = 0.90f;
//	float p_bandwidth = 0.05;
//	float d_bandwidth = 0.9f;





	for(i = 200; i >= 2; i--)
	{
		float max_p, max_d;
		test_freq(i, 
			p_bandwidth, 
			d_bandwidth,
			&max_p,
			&max_d);
		
		printf("%d,%f,%f,%f\n", i, max_p, max_d, max_p + max_d);
	}
printf("\n\n\n");

	filter_t p_filter, d_filter;
	init_filter(&p_filter, data[0], p_bandwidth);
	init_filter(&d_filter, data[0], d_bandwidth);

	float prev_value = 0;

	for(i = 1; i < TOTAL_ENTRIES; i++)
	{
		float value = data[i];
		if(i < 400)
		{
			value = data[400];
		}
		else
		if(i > 460)
		{
			value = data[460];
		}

// lowpass filter
		float p = do_lowpass(&p_filter, value);
		
// highpass filter
		float d = do_highpass(&d_filter, value);

		printf("%f,%f,%f,%f,%f\n", 
// input
			value, 
// lowpass filter
			p,
// highpass filter
			d,
// summed filters
			p + 3 * d,
// P + D
			value + 10 * (value - prev_value));
		
		
		prev_value = value;
	}


}








